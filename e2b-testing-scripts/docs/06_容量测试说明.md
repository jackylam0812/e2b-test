# E2B 沙箱容量和负载均衡测试说明

## 测试目的

本测试用于评估 E2B 集群的以下关键指标：

1. **集群总容量** - 最大并发沙箱数量
2. **单机沙箱密度** - 每个节点能承载的最大沙箱数
3. **调度均衡性** - 沙箱在各节点间的分布是否均匀
4. **资源利用率** - 节点资源的使用效率

## 测试原理

测试脚本会：
1. 逐批创建沙箱，每批创建指定数量的沙箱
2. 监控创建成功率，检测容量上限
3. 通过 `e2b sbx list` 获取所有沙箱信息
4. 通过 Nomad API 获取节点信息
5. 分析沙箱在各节点的分布情况
6. 计算负载均衡指标

## 前置要求

### 1. 环境配置

确保已配置以下环境变量：

```bash
# 必需
export E2B_DOMAIN='your-domain.com'
export E2B_API_KEY='your-api-key'

# 可选（用于获取节点信息）
export NOMAD_ADDR='https://nomad.your-domain.com/'
export NOMAD_TOKEN='your-nomad-token'

# 可选（使用特定模板）
export E2B_TEMPLATE_NAME='your-template-name'
```

### 2. 安装 E2B CLI

测试脚本需要使用 E2B CLI 工具获取沙箱列表：

```bash
# 使用 npm 安装
npm install -g @e2b/cli

# 验证安装
e2b --version
```

### 3. Python 依赖

```bash
pip install e2b requests urllib3
```

## 使用方法

### 基本用法

```bash
# 加载环境变量
source .e2b_env

# 运行测试（默认参数）
python3 tests/client/06_sandbox_capacity.py
```

### 参数说明

| 参数 | 类型 | 默认值 | 说明 |
|-----|------|--------|------|
| `--batch-size` | int | 10 | 每批创建的沙箱数量 |
| `--max-sandboxes` | int | 1000 | 最大尝试创建的沙箱数（防止无限创建） |
| `--interval` | float | 2.0 | 批次之间的间隔时间（秒） |
| `--timeout` | int | 300 | 单个沙箱创建的超时时间（秒） |
| `--output` | str | outputs/06_sandbox_capacity.json | 输出文件路径 |

### 示例场景

#### 1. 快速测试（小规模）

适用于开发环境或快速验证：

```bash
python3 tests/client/06_sandbox_capacity.py \
  --batch-size 5 \
  --max-sandboxes 50 \
  --interval 1
```

#### 2. 标准测试（中等规模）

适用于常规容量评估：

```bash
python3 tests/client/06_sandbox_capacity.py \
  --batch-size 10 \
  --max-sandboxes 200 \
  --interval 2
```

#### 3. 压力测试（大规模）

适用于找出真实容量上限：

```bash
python3 tests/client/06_sandbox_capacity.py \
  --batch-size 20 \
  --max-sandboxes 1000 \
  --interval 3
```

#### 4. 渐进式测试（保守）

适用于生产环境，更加保守：

```bash
python3 tests/client/06_sandbox_capacity.py \
  --batch-size 5 \
  --max-sandboxes 500 \
  --interval 5
```

## 测试输出

### 终端输出示例

```
============================================================
E2B 沙箱容量和负载均衡测试
============================================================
配置:
  E2B 域名: example.com
  模板: next_agent_sbx_dev
  批次大小: 10
  最大沙箱数: 100
  批次间隔: 2秒
============================================================

[批次 1] 创建 10 个沙箱...
  创建沙箱 #1... ✓ (ID: sbx_abc123)
  创建沙箱 #2... ✓ (ID: sbx_def456)
  ...
  本批次成功: 10/10
  累计成功: 10
  累计失败: 0
  等待 2 秒...

...

============================================================
容量测试完成
============================================================
成功创建沙箱数: 95
失败创建数: 5
最大容量: 95

获取沙箱列表 (通过 e2b sbx list)...
✓ 获取到 95 个沙箱

获取 Nomad 节点信息...
✓ 获取到 3 个节点信息

============================================================
沙箱分布统计
============================================================
总节点数: 3
总沙箱数: 95
单节点最大: 35
单节点最小: 28
单节点平均: 31.67
单节点中位数: 32.00
标准差: 3.06
变异系数: 0.0967
均衡得分: 90.33% (越接近100%越均衡)

各节点详细分布:
  node-1: 35 个沙箱 (36.8%)
  node-2: 32 个沙箱 (33.7%)
  node-3: 28 个沙箱 (29.5%)

============================================================
清理沙箱资源
============================================================
关闭沙箱 1/95 (ID: sbx_abc123)... ✓
...

清理完成: 95 成功, 0 失败

✓ 测试结果已保存到: outputs/06_sandbox_capacity.json

============================================================
测试完成!
============================================================
```

### JSON 输出格式

输出文件 `outputs/06_sandbox_capacity.json` 包含：

```json
{
  "total_created": 95,
  "total_failed": 5,
  "max_capacity": 95,
  "node_distribution": {
    "node-1": {
      "node_id": "abc123",
      "sandbox_count": 35,
      "percentage": 36.8
    },
    "node-2": {
      "node_id": "def456",
      "sandbox_count": 32,
      "percentage": 33.7
    },
    "node-3": {
      "node_id": "ghi789",
      "sandbox_count": 28,
      "percentage": 29.5
    }
  },
  "balance_metrics": {
    "total_nodes": 3,
    "total_sandboxes": 95,
    "max_per_node": 35,
    "min_per_node": 28,
    "avg_per_node": 31.67,
    "median_per_node": 32.0,
    "stddev": 3.06,
    "cv": 0.0967,
    "balance_score": 0.9033
  },
  "test_timestamp": "2025-11-25T06:00:00.000000"
}
```

## 指标解释

### 容量指标

- **total_created**: 成功创建的沙箱总数
- **total_failed**: 失败的创建尝试次数
- **max_capacity**: 达到的最大容量（即成功创建的沙箱数）

### 分布指标

- **total_nodes**: 节点总数
- **total_sandboxes**: 沙箱总数
- **max_per_node**: 单节点最大沙箱数
- **min_per_node**: 单节点最小沙箱数
- **avg_per_node**: 单节点平均沙箱数
- **median_per_node**: 单节点中位数沙箱数

### 均衡性指标

- **stddev**: 标准差 - 衡量分布离散程度，越小越均衡
- **cv**: 变异系数 (Coefficient of Variation) - 标准差与平均值的比值，越小越均衡
- **balance_score**: 均衡得分 = 1 - cv，范围 [0, 1]，越接近 1 越均衡

**均衡性评级**：
- `balance_score >= 0.95`: 优秀 (Very Good) - 负载非常均衡
- `0.90 <= balance_score < 0.95`: 良好 (Good) - 负载较为均衡
- `0.80 <= balance_score < 0.90`: 一般 (Fair) - 负载有一定倾斜
- `balance_score < 0.80`: 较差 (Poor) - 负载不均衡，需要优化

## 注意事项

### 1. 资源清理

测试完成后，脚本会自动清理所有创建的沙箱。如果脚本异常退出，可能需要手动清理：

```bash
# 查看所有沙箱
e2b sbx list

# 批量删除沙箱（谨慎使用）
e2b sbx list --json | jq -r '.[].sandboxId' | xargs -I {} e2b sbx kill {}
```

### 2. 生产环境测试

在生产环境进行容量测试时：
- 选择低峰时段
- 使用较小的 batch-size 和较长的 interval
- 提前通知相关团队
- 准备回滚方案

### 3. 容量规划建议

- **安全容量** = 测试最大容量 × 0.7
- **预警阈值** = 测试最大容量 × 0.8
- **硬上限** = 测试最大容量 × 0.9

### 4. 节点信息获取

如果无法从 `e2b sbx list` 获取节点分布信息，可能的原因：
- E2B CLI 版本不支持
- API 响应格式变化
- 需要额外的权限

可以通过 Nomad API 或其他监控工具补充节点信息。

## 故障排查

### 问题：无法创建沙箱

**可能原因**：
- API 密钥错误
- 域名配置错误
- 网络连接问题
- 已达到配额限制

**解决方法**：
```bash
# 检查环境变量
echo $E2B_DOMAIN
echo $E2B_API_KEY

# 手动测试创建沙箱
e2b sandbox create
```

### 问题：无法获取沙箱列表

**可能原因**：
- E2B CLI 未安装
- E2B CLI 版本过旧
- 权限不足

**解决方法**：
```bash
# 检查 CLI 版本
e2b --version

# 更新 CLI
npm update -g @e2b/cli

# 手动测试
e2b sbx list
```

### 问题：节点信息为空

**可能原因**：
- 未配置 Nomad 访问信息
- Nomad token 无效
- 网络不可达

**解决方法**：
```bash
# 检查 Nomad 配置
echo $NOMAD_ADDR
echo $NOMAD_TOKEN

# 测试 Nomad API
curl -H "X-Nomad-Token: $NOMAD_TOKEN" "$NOMAD_ADDR/v1/nodes"
```

## 最佳实践

1. **分阶段测试**：
   - 先小规模测试（50个）验证脚本
   - 再中等规模测试（200个）评估容量
   - 最后大规模测试找到真实上限

2. **定期测试**：
   - 每月进行一次容量测试
   - 在重大配置变更后重新测试
   - 记录历史数据，追踪趋势

3. **结果分析**：
   - 对比不同时间段的测试结果
   - 分析节点负载不均衡的原因
   - 根据结果调整调度策略

4. **容量管理**：
   - 设置监控告警（达到80%容量）
   - 提前扩容（达到预警阈值）
   - 定期review容量规划

## 相关文档

- [E2B服务基准测试指标定义.md](../E2B服务基准测试指标定义.md)
- [README.md](../README.md)
